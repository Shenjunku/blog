---
title: 强缓存和协商缓存
date: 2022-8-02
sidebar: 'auto'
categories:
 - 前端
tags:
 - 前端
---

#### 游览器缓存机制

##### Http缓存可以分为两大类，强制缓存（也称强缓存）和协商缓存。两类缓存规则不同，强制缓存在缓存数据未失效的情况下，不需要再和服务器发生交互；而协商缓存，顾名思义，需要进行比较判断是否可以使用缓存。

两类缓存规则可以同时存在，强制缓存优先级高于协商缓存，也就是说，当执行强制缓存的规则时，如果缓存生效，直接使用缓存，不再执行协商缓存规则。

##### 强缓存：

1. 网站向服务器发送请求 ，
2. 游览器返回相对资源例如css文件js文件图片资源，
3. 服务器在响应头 （response headers ）设置Cache-Control max-age设置一个时间，
4. 如果后面再次请求这个接口，判断时间有没有过期，没过期直接从缓存里拿资源，过期的话会从新返回新的资源

##### 协商缓存：

1. 网站向服务器发送请求 ，
2. 游览器返回相对资源（例如css文件js文件图片资源）和资源标识，
3. 后续如果重新请求，请求会带上次的资源标识，服务器判断当前资源和游览器资源是否一致，
4. 如何不是最新资源，服务器返回200状态码、最新资源和新的资源标识，
5. 如何是最新资源，服务器返回304状态码，直接从缓存里拿缓存。

##### 资源标识分为两种，Last-Modified和ETag

##### Last-Modified：文件上次修改时间（资源文件在服务器最后被修改的时间。）

- 浏览器请求静态资源
- 服务器返回资源给浏览器，同时带上文件上次修改时间 Last-Modified（GMT标准格式）
- 当浏览器上的缓存文件过期时或者从新发起该请求，浏览器带上请求头`If-Modified-Since`（等于上一次请求的Last-Modified）请求服务器
- 服务器比较请求头里的`If-Modified-Since`和文件的上次修改时间。如果果一致就继续使用本地缓存（304），如果不一致就再次返回文件内容和Last-Modified。
- 循环请求。。

##### 缺点

- 由于Last-Modified修改时间是GMT时间，只能精确到秒，如果文件在1秒内有多次改动，服务器并不知道文件有改动，浏览器拿不到最新的文件
- 如果服务器上文件被多次修改了但是内容却没有发生改变，服务器需要再次重新返回文件。

为了解决文件修改时间不精确带来的问题，服务器和浏览器再次协商，这次不返回时间，返回文件的唯一标识ETag。只有当文件内容改变时，ETag才改变。

##### ETag：资源文件的一个唯一标识(由服务器生成)

- 浏览器请求静态资源
- 服务器返回资源给浏览器，同时带上文件的唯一标识ETag
- 当浏览器上的缓存文件过期时或者从新发起该请求，浏览器带上请求头`If-None-Match`（等于上一次请求的ETag）请求服务器
- 服务器比较请求头里的`If-None-Match`和文件的ETag。如果一致就继续使用本地缓存（304），如果不一致就再次返回文件内容和ETag。
- 循环请求。。

